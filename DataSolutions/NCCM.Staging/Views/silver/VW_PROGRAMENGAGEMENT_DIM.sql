CREATE VIEW [silver.NCCM].VW_PROGRAMENGAGEMENT_DIM
AS
    SELECT 
        UPPER(stm.PROGRAM_ENGAGEMENT_ID) AS UQ_KEY,
        HASHBYTES('MD5', UPPER(stm.PROGRAM_ENGAGEMENT_ID)) AS UQ_KEY_HASH,
        '||' AS NK_STRING,
        HASHBYTES('MD5', CONCAT(
            stm.COMMENCEMENT_OF_SERVICING_DATE,
            stm.PMDM__CONTACT,
            stm.CONTRACT_REFERENCE_ID,
            stm.CONTRACT_REFERRAL_START_DATE,
            stm.CONTRACT_REFERRAL_STATUS,
            stm.CRN,
            stm.DES_PROGRAM_TYPE_CODE,
            stm.ECM_CASE_ID,
            stm.EMPLOYMENT_BENCHMARK,
            stm.ESAT_JCA_ASSESSMENT_DATE,
            stm.EXIT_DATE,
            stm.FUNDING_LEVEL,
            stm.INDIGENOUS_INDICATOR,
            stm.JOB_PLAN_STATUS,
            stm.JSCI_ASSESSMENT_DATE,
            stm.JSCI_STATUS,
            stm.LATEST_RESUME_DATE,
            stm.LINKED_ACTIVITY,
            stm.MATURE_AGE,
            stm.NEIS_FLAG,
            stm.NEXT_APPOINTMENT_DATE,
            stm.NEXT_SERVICE_DELIVERY,
            stm.ORIGINAL_COMMENCEMENT_DATE,
            stm.OTHER_PERSONAL_ISSUES_BARRIERS,
            stm.OWNERID,
            stm.PARTICIPATION_PLAN_STATUS,
            stm.PERIOD_OF_SERVICE,
            stm.POI_CHECKED,
            stm.PRINCIPAL_PARENT_CARER,
            stm.PROGRAM_NAME,
            stm.REFERRAL_DATE,
            stm.REFERRAL_PHASE_CODE,
            stm.REFERRAL_STATUS_CODE,
            stm.REFUGEE_HUMANITARIAN_VISA,
            stm.SERVICING_PLACEMENT_STATUS,
            stm.SITE_CODE,
            stm.SSI_SITE,
            stm.SUSPENSION_REASON_DESCRIPTION,
            stm.THINK_TIME_DAYS,
            stm.THINK_TIME_ELECTED,
            stm.TRAFFIC_LIGHT,
            stm.IS_DELETED,
            stm.ORIGINAL_SYSTEM_CREATED_DATE,
            stm.APPLICATION_DATE,
            stm.ACCOUNT,
            stm.PILOT_PROGRAM_PHASE__C,
            stm.JOB_SEEKER_ID__C,
            stm.PMDM__STARTDATE__C,
            stm.PMDM__STAGE__C,
            stm.CLIENT_CASE_PROGRAM_ENGAGEMENT_ID,
            stm.CLIENT_CASE_CREATED_DATE,
            stm.CLIENT_CASE_DATE_OF_EXIT,
            stm.CLIENT_CASE_OWNER_ID,
            stm.CLIENT_CASE_SUBURB__C,
            stm.CLIENT_CASE_POSTAL__CODE
        )) AS ROW_HASH_SUM,
        stm.*
    FROM (
        SELECT
            tbl.ID AS PROGRAM_ENGAGEMENT_ID,
            tbl.COMMENCEMENT_OF_SERVICING_DATE__C AS COMMENCEMENT_OF_SERVICING_DATE,
            tbl.PMDM__CONTACT__C AS PMDM__CONTACT,
            tbl.CONTRACT_REFERENCE_ID__C AS CONTRACT_REFERENCE_ID,
            tbl.CONTRACT_REFERRAL_START_DATE__C AS CONTRACT_REFERRAL_START_DATE,
            tbl.CONTRACT_REFERRAL_STATUS__C AS CONTRACT_REFERRAL_STATUS,
            tbl.CRN__C AS CRN,
            tbl.DES_PROGRAM_TYPE_CODE__C AS DES_PROGRAM_TYPE_CODE,
            tbl.ECM_CASE_ID__C AS ECM_CASE_ID,
            tbl.EMPLOYMENT_BENCHMARK__C AS EMPLOYMENT_BENCHMARK,
            tbl.ESAT_JCA_ASSESSMENT_DATE__C AS ESAT_JCA_ASSESSMENT_DATE,
            tbl.EXIT_DATE__C AS EXIT_DATE,
            tbl.FUNDING_LEVEL__C AS FUNDING_LEVEL,
            tbl.INDIGENOUS_INDICATOR__C AS INDIGENOUS_INDICATOR,
            tbl.JOB_PLAN_STATUS__C AS JOB_PLAN_STATUS,
            tbl.JSCI_ASSESSMENT_DATE__C AS JSCI_ASSESSMENT_DATE,
            tbl.JSCI_STATUS__C AS JSCI_STATUS,
            tbl.LATEST_RESUME_DATE__C AS LATEST_RESUME_DATE,
            tbl.LINKED_ACTIVITY__C AS LINKED_ACTIVITY,
            tbl.MATURE_AGE__C AS MATURE_AGE,
            tbl.NEIS_FLAG__C AS NEIS_FLAG,
            tbl.NEXT_APPOINTMENT_DATE__C AS NEXT_APPOINTMENT_DATE,
            tbl.NEXT_SERVICE_DELIVERY__C AS NEXT_SERVICE_DELIVERY,
            tbl.ORIGINAL_COMMENCEMENT_DATE__C AS ORIGINAL_COMMENCEMENT_DATE,
            tbl.OTHER_PERSONAL_ISSUES_BARRIERS__C AS OTHER_PERSONAL_ISSUES_BARRIERS,
            tbl.OWNERID__C AS OWNERID,
            tbl.PARTICIPATION_PLAN_STATUS__C AS PARTICIPATION_PLAN_STATUS,
            tbl.PERIOD_OF_SERVICE__C AS PERIOD_OF_SERVICE,
            tbl.POI_CHECKED__C AS POI_CHECKED,
            tbl.PRINCIPAL_PARENT_CARER__C AS PRINCIPAL_PARENT_CARER,
            tbl.PROGRAM_NAME__C AS PROGRAM_NAME,
            tbl.REFERRAL_DATE__C AS REFERRAL_DATE,
            tbl.REFERRAL_PHASE_CODE__C AS REFERRAL_PHASE_CODE,
            tbl.REFERRAL_STATUS_CODE__C AS REFERRAL_STATUS_CODE,
            tbl.REFUGEE_HUMANITARIAN_VISA__C AS REFUGEE_HUMANITARIAN_VISA,
            tbl.SERVICING_PLACEMENT_STATUS__C AS SERVICING_PLACEMENT_STATUS,
            tbl.SITE_CODE__C AS SITE_CODE,
            tbl.SSI_SITE__C AS SSI_SITE,
            tbl.SUSPENSION_REASON_DESCRIPTION__C AS SUSPENSION_REASON_DESCRIPTION,
            tbl.THINK_TIME_DAYS__C AS THINK_TIME_DAYS,
            tbl.THINK_TIME_ELECTED__C AS THINK_TIME_ELECTED,
            tbl.TRAFFIC_LIGHT__C AS TRAFFIC_LIGHT,
            tbl.ISDELETED AS IS_DELETED,
            tbl.CREATEDDATE AS ORIGINAL_SYSTEM_CREATED_DATE,
            tbl.PMDM__APPLICATIONDATE__C AS APPLICATION_DATE,
            tbl.PMDM__ACCOUNT__C AS ACCOUNT,
            tbl.PILOT_PROGRAM_PHASE__C,
            tbl.JOB_SEEKER_ID__C,
            tbl.PMDM__STARTDATE__C,
            tbl.PMDM__STAGE__C,
            cl.PROGRAM_ENGAGEMENT_ID AS CLIENT_CASE_PROGRAM_ENGAGEMENT_ID,
            cl.CREATED_DATE AS CLIENT_CASE_CREATED_DATE,
            cl.DATE_OF_EXIT AS CLIENT_CASE_DATE_OF_EXIT,
            cl.OWNER_ID AS CLIENT_CASE_OWNER_ID,
            cl.SUBURB__C AS CLIENT_CASE_SUBURB__C,
            cl.STAGE__C as STAGE__C,
            cl.POSTAL__CODE AS CLIENT_CASE_POSTAL__CODE,
            ROW_NUMBER() OVER(PARTITION BY cl.PROGRAM_ENGAGEMENT_ID ORDER BY cl.CREATED_DATE DESC) AS RN
        FROM [bronze.NCCM].PROGRAMENGAGEMENT AS tbl
            LEFT JOIN [bronze.NCCM].CLIENT_CASE AS cl
                ON tbl.ID=cl.PROGRAM_ENGAGEMENT_ID
    ) AS stm
    WHERE stm.RN = 1;
