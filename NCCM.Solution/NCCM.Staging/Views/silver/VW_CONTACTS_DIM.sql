CREATE VIEW [silver.NCCM].VW_CONTACTS_DIM
AS
    SELECT 
        UPPER(stm.CONTACT_ID) AS UQ_KEY,
        HASHBYTES('MD5', UPPER(stm.CONTACT_ID)) AS UQ_KEY_HASH,
        UPPER(CONCAT(stm.FIRST_NAME, '||', stm.LAST_NAME, '||', stm.BIRTH_DATE)) AS NK_STRING,
        HASHBYTES('MD5', CONCAT(
            stm.LAST_NAME,
            stm.FIRST_NAME,
            stm.BIRTH_DATE,
            stm.GENDER,
            stm.JOB_SEEKER_ID,
            stm.ACCOUNT_ID,
            stm.IS_DELETED,
            stm.DFV_ABUSE_COERCIVE_CONTROL,
            stm.DFV_ABUSE_CULTURAL_SPIRITUAL,
            stm.DFV_ABUSE_DOMESTIC_SERVITUDE,
            stm.DFV_ABUSE_DOWRY,
            stm.DFV_ABUSE_EMOTIONAL_PSYCHOLOGICAL,
            stm.DFV_ABUSE_FINANCIAL,
            stm.DFV_ABUSE_FORCED_MARRIAGE,
            stm.DFV_ABUSE_HARRASSMENT_STALKING,
            stm.DFV_ABUSE_IMMIGRATION_FACILITATED,
            stm.DFV_ABUSE_MULTIPERPETRATOR,
            stm.DFV_ABUSE_PHYSICAL,
            stm.DFV_ABUSE_REPRODUCTIVE,
            stm.DFV_ABUSE_SEXUAL,
            stm.DFV_ABUSE_STRANGULATION,
            stm.DFV_ABUSE_SYSTEMS,
            stm.DFV_ABUSE_TECHNOLOGY_FACILITATED,
            stm.DFV_ABUSE_VERBAL,
            stm.DFV_BARRIER_TO_DISCLOSURE_CULTURAL,
            stm.DFV_BARRIER_TO_DISCLOSURE_LANGUAGE,
            stm.DFV_BARRIER_TO_DISCLOSURE_MISIDENTIFY,
            stm.DFV_BARRIER_TO_DISCLOSURE_SYSTEM,
            stm.DFV_CASE_CONFERENCE_DATE,
            stm.DFV_CHILDREN_UNDER_18,
            stm.VULNERABLE_YOUTH,
            stm.VULNERABLE_YOUTH_STUDENT,
            stm.DISABILITY_TYPE,
            stm.INTERPRETER_LANGUAGE,
            stm.MENTAL_ILLNESS_FLAG,
            stm.CALD,
            stm.EDUCATION_LEVEL,
            stm.AGE_OF_YOUNGEST_CHILD
        )) AS ROW_HASH_SUM,
        stm.*
    FROM (
        SELECT
            tbl.ID AS CONTACT_ID,
            tbl.LASTNAME AS LAST_NAME,
            tbl.FIRSTNAME AS FIRST_NAME,
            tbl.BIRTHDATE AS BIRTH_DATE,
            tbl.GENDER__C AS GENDER,
            tbl.JOBSEEKERID__C AS JOB_SEEKER_ID,
            tbl.ACCOUNTID AS ACCOUNT_ID,
            tbl.ISDELETED AS IS_DELETED,
            -- from Program Engagement per latest Contact across their programs
            prg.DFV_ABUSE_COERCIVE_CONTROL__C AS DFV_ABUSE_COERCIVE_CONTROL,
            prg.DFV_ABUSE_CULTURAL_SPIRITUAL__C AS DFV_ABUSE_CULTURAL_SPIRITUAL,
            prg.DFV_ABUSE_DOMESTIC_SERVITUDE__C AS DFV_ABUSE_DOMESTIC_SERVITUDE,
            prg.DFV_ABUSE_DOWRY__C AS DFV_ABUSE_DOWRY,
            prg.DFV_ABUSE_EMOTIONAL_PSYCHOLOGICAL__C AS DFV_ABUSE_EMOTIONAL_PSYCHOLOGICAL,
            prg.DFV_ABUSE_FINANCIAL__C AS DFV_ABUSE_FINANCIAL,
            prg.DFV_ABUSE_FORCED_MARRIAGE__C AS DFV_ABUSE_FORCED_MARRIAGE,
            prg.DFV_ABUSE_HARRASSMENT_STALKING__C AS DFV_ABUSE_HARRASSMENT_STALKING,
            prg.DFV_ABUSE_IMMIGRATION_FACILITATED__C AS DFV_ABUSE_IMMIGRATION_FACILITATED,
            prg.DFV_ABUSE_MULTIPERPETRATOR__C AS DFV_ABUSE_MULTIPERPETRATOR,
            prg.DFV_ABUSE_PHYSICAL__C AS DFV_ABUSE_PHYSICAL,
            prg.DFV_ABUSE_REPRODUCTIVE__C AS DFV_ABUSE_REPRODUCTIVE,
            prg.DFV_ABUSE_SEXUAL__C AS DFV_ABUSE_SEXUAL,
            prg.DFV_ABUSE_STRANGULATION__C AS DFV_ABUSE_STRANGULATION,
            prg.DFV_ABUSE_SYSTEMS__C AS DFV_ABUSE_SYSTEMS,
            prg.DFV_ABUSE_TECHNOLOGY_FACILITATED__C AS DFV_ABUSE_TECHNOLOGY_FACILITATED,
            prg.DFV_ABUSE_VERBAL__C AS DFV_ABUSE_VERBAL,
            prg.DFV_BARRIER_TO_DISCLOSURE_CULTURAL__C AS DFV_BARRIER_TO_DISCLOSURE_CULTURAL,
            prg.DFV_BARRIER_TO_DISCLOSURE_LANGUAGE__C AS DFV_BARRIER_TO_DISCLOSURE_LANGUAGE,
            prg.DFV_BARRIER_TO_DISCLOSURE_MISIDENTIFY__C AS DFV_BARRIER_TO_DISCLOSURE_MISIDENTIFY,
            prg.DFV_BARRIER_TO_DISCLOSURE_SYSTEM__C AS DFV_BARRIER_TO_DISCLOSURE_SYSTEM,
            prg.DFV_CASE_CONFERENCE_DATE__C AS DFV_CASE_CONFERENCE_DATE,
            prg.DFV_CHILDREN_UNDER_18__C AS DFV_CHILDREN_UNDER_18,
            prg.VULNERABLE_YOUTH__C AS VULNERABLE_YOUTH,
            prg.VULNERABLE_YOUTH_STUDENT__C AS VULNERABLE_YOUTH_STUDENT,
            prg.DISABILITY_TYPE__C AS DISABILITY_TYPE,
            prg.INTERPRETER_LANGUAGE__C AS INTERPRETER_LANGUAGE,
            prg.MENTAL_ILLNESS_FLAG__C AS MENTAL_ILLNESS_FLAG,
            prg.CALD__C AS CALD,
            prg.EDUCATION_LEVEL__C AS EDUCATION_LEVEL,
            prg.AGE_OF_YOUNGEST_CHILD__C AS AGE_OF_YOUNGEST_CHILD,
            prg.ID AS PROGRAM_ENGAGEMENT_ID
        FROM [bronze.NCCM].CONTACTS AS tbl
            LEFT JOIN [bronze.NCCM].PROGRAMENGAGEMENT AS prg
                ON prg.PMDM__CONTACT__C = tbl.ID
                AND prg.LAST_CONTACT_ACROSS_ALL_THEIR_ENGAGEMENTS = 1
    ) AS stm;
